name: charmed-karapace
summary: Charmed Karapace ROCK
description: |
  This is an OCI image that bundles Karapace binaries together with other
  tools of its ecosystem in order to be used in Charmed Operators, providing
  an automated and seamless experience to deploy, operate, manage and monitor
  Karapace on K8s cluster.
  It is an open source, end-to-end, production ready data platform on top of
  cloud native technologies.

license: Apache-2.0
version: '3.12.0'
base: ubuntu@22.04
platforms: # The platforms this rock should be built on and run on
  amd64:

run_user: _daemon_

services:
  karapace:
    command: karapace /etc/karapace/karapace.config.json
    summary: "This is the service to startup Karapace processes"
    override: replace
    startup: enabled


parts:
  karapace:
    plugin: python
    source: https://github.com/Aiven-Open/karapace.git
    source-tag: 3.12.0
    python-requirements:
        - ./requirements/requirements.txt
    # stage-snaps:
    #   - charmed-karapace/latest/edge
    stage-packages:
      - python3.10-venv
      - util-linux

    # override-prime: |
    #   rm $CRAFT_PART_INSTALL/bin/python
    #   rm $CRAFT_PART_INSTALL/bin/python3
    #   rm $CRAFT_PART_INSTALL/bin/python3.10
    #   rm $CRAFT_PART_INSTALL/bin/pip
    #   rm $CRAFT_PART_INSTALL/bin/pip3
    #   rm $CRAFT_PART_INSTALL/bin/pip3.10
    #   craftctl default

  # dependencies:
  #   plugin: nil
  #   after: [karapace-snap]
  #   stage-packages:
  #     - python3
  #     - python3-pip
  #   override-prime:
  #     pip install aiokafka==0.8.1

  #     craftctl default
  entry:
    plugin: dump
    after: [karapace]
    source: files
    organize:
      authfile.json: etc/karapace/authfile.json
      karapace.config.json: etc/karapace/karapace.config.json
    stage:
      - etc/karapace/authfile.json
      - etc/karapace/karapace.config.json
    override-prime: |
      craftctl default
      ROCK_USER_UID=584792
      chown -R ${ROCK_USER_UID}:${ROCK_USER_UID} etc/karapace/
